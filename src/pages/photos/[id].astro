---
import { getCollection, getEntry } from 'astro:content';
import ImageKit from 'imagekit';
import { IK_ENDPOINT, IK_PUBLIC_KEY, IK_PRIVATE_KEY } from 'astro:env/server';

import Photos_ from '$components/Photos.svelte';
import Base from '$layouts/Base.astro';

export async function getStaticPaths() {
  const photos = await getCollection('photos');
  return photos.map((entry) => ({ params: { id: entry.id } }));
}

const { id } = Astro.params;
const entry = await getEntry('photos', id);
if (!entry) throw new Error();
const photos = (await getCollection('photos')).map((entry) => entry.data);

const ik = new ImageKit({
  publicKey: IK_PUBLIC_KEY,
  privateKey: IK_PRIVATE_KEY,
  urlEndpoint: IK_ENDPOINT,
});

const ogImage = ik.url({
  path: entry.data.path,
  transformation: [{ width: 1200, height: 630, focus: entry.data.focus }],
});
---

<Base title="Photos" description="My local Instagram." coverImage={ogImage}>
  <Fragment slot="extra-head">
    <link
      rel="alternate"
      type="application/rss+xml"
      title="Photos Â· zakj.net"
      href={new URL('/photos/feed.xml', Astro.site)}
    />
  </Fragment>
  <Photos_ images={photos} selectedId={id} client:idle />
</Base>
